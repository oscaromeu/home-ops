---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: tempo
spec:
  interval: 15m
  chart:
    spec:
      chart: tempo-distributed
      version: 1.41.1
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
  valuesFrom:
    - targetPath: storage.trace.s3.endpoint
      kind: Secret
      name: tempo-s3-secret
      valuesKey: endpoint
    - targetPath: storage.trace.s3.access_key
      kind: Secret
      name: tempo-s3-secret
      valuesKey: AWS_ACCESS_KEY_ID
    - targetPath: storage.trace.s3.secret_key
      kind: Secret
      name: tempo-s3-secret
      valuesKey: AWS_SECRET_ACCESS_KEY
  values:
    global:
      clusterDomain: 'cluster.local'
    useExternalConfig: false
    reportingEnabled: false
    tempo:
      image:
        registry: docker.io
        pullSecrets: []
        repository: grafana/tempo
        tag: 2.8.0
        pullPolicy: IfNotPresent
      structuredConfig:
        query_frontend:
          search:
            max_duration: 168h
          metrics:
            max_duration: 168h
        compactor:
          compaction:
            block_retention: 168h
    ingester:
      replicas: 2
      #resources:
      #  requests:
      #    cpu: "500m"
      #    memory: "1Gi"
      #  limits:
      #    memory: "2Gi"
      #extraArgs:
      #  - "-config.expand-env=true" 
    metricsGenerator:
      enabled: true
      #resources:
      #  requests:
      #    cpu: "500m"
      #    memory: "1Gi"
      #  limits:
      #    memory: "2Gi"
      config:
        registry:
          collection_interval: 15s
          external_labels: {}
          stale_duration: 15m
        storage:
          path: /var/tempo/wal
          wal:
          remote_write_flush_deadline: 1m
          remote_write:
            - url: http://kube-prometheus-stack-prometheus.observability.svc.cluster.local:9090/api/v1/write
        traces_storage:
          path: /var/tempo/traces
        metrics_ingestion_time_range_slack: 30s
      #extraArgs:
      #  - "-config.expand-env=true"
      #extraEnvFrom:
      #  - secretRef:
      #      name: tempo-s3-secret
    distributor:
      replicas: 2
      #resources:
      #  requests:
      #    cpu: "500m"
      #    memory: "1Gi"
      #  limits:
      #    memory: "2Gi"
      #extraArgs:
      #  - "-config.expand-env=true"
      #extraEnvFrom:
      #  - secretRef:
      #      name: tempo-s3-secret
    compactor:
      replicas: 2
      #resources:
      #  requests:
      #    cpu: "500m"
      #    memory: "1Gi"
      #  limits:
      #    memory: "2Gi"
      #extraArgs:
      #  - "-config.expand-env=true"
      #extraEnvFrom:
      #  - secretRef:
      #      name: tempo-s3-secret
    #querier:
    #  extraArgs:
    #    - "-config.expand-env=true"
    #  extraEnvFrom:
    #    - secretRef:
    #        name: tempo-s3-secret
    #  #resources:
    #  #  requests:
    #  #    cpu: "500m"
    #  #    memory: "1Gi"
    #  #  limits:
    #  #    memory: "2Gi"
    queryFrontend:
      replicas: 2
      #resources:
      #  requests:
      #    cpu: "500m"
      #    memory: "1Gi"
      #  limits:
      #    memory: "2Gi"
      #extraArgs:
      #  - "-config.expand-env=true"
      #extraEnvFrom:
      #  - secretRef:
      #      name: tempo-s3-secret
    storage:
      trace:
        backend: s3
        s3:
          insecure: true  # optional. enable if endpoint is http
          bucket: tempo-data
          region: ''
    overrides:
      defaults:
        metrics_generator:
          processors:
            - service-graphs
            - span-metrics
            - local-blocks
          #processor:
          #  local_blocks:
          #    filter_server_spans: false
          #    #flush_to_storage: true
    gateway:
      enabled: true
      replicas: 2
      #resources:
      #  requests:
      #    cpu: "500m"
      #    memory: "1Gi"
      #  limits:
      #    memory: "2Gi"
    metaMonitoring:
      serviceMonitor:
        enabled: true