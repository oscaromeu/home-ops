---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: tempo
  namespace: observability
spec:
  interval: 15m
  chart:
    spec:
      chart: tempo-distributed
      version: 1.41.1
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
  maxHistory: 3
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false

  valuesFrom:
    - targetPath: storage.trace.s3.bucket
      kind: Secret
      name: &s3-secret loki-s3-bucket
      valuesKey: S3_BUCKET_NAME

    - targetPath: storage.trace.s3.endpoint
      kind: Secret
      name: *s3-secret
      valuesKey: S3_BUCKET_HOST

    - targetPath: storage.trace.s3.region
      kind: Secret
      name: *s3-secret
      valuesKey: S3_BUCKET_REGION

    - targetPath: storage.trace.s3.access_key
      kind: Secret
      name: *s3-secret
      valuesKey: S3_ACCESS_KEY_ID

    - targetPath: storage.trace.s3.secret_key
      kind: Secret
      name: *s3-secret
      valuesKey: S3_SECRET_ACCESS_KEY

  values:
    global:
      clusterDomain: 'cluster.local'

    useExternalConfig: false

    reportingEnabled: false

    ingester:
      replicas: 2

      extraArgs:
        - "-config.expand-env=true"

      extraEnvFrom:
        - secretRef:
            name: tempo-s3-bucket

      persistence:
        enabled: true
        storageClass: openebs-hostpath
        size: 10Gi

    metricsGenerator:
      enabled: true

      config:
        registry:
          collection_interval: 15s
          external_labels: {}
          stale_duration: 15m

        storage:
          path: /var/tempo/wal
          wal:
          remote_write_flush_deadline: 1m
          remote_write:
            - url: http://kube-prometheus-stack-prometheus.observability.svc.cluster.local:9090/api/v1/write

        traces_storage:
          path: /var/tempo/traces

        metrics_ingestion_time_range_slack: 30s

      extraArgs:
        - "-config.expand-env=true"

      extraEnvFrom:
        - secretRef:
            name: tempo-s3-bucket

      persistence:
        enabled: true
        storageClass: openebs-hostpath
        size: 10Gi

    distributor:
      config:
        log_received_spans:
          enabled: true

      extraArgs:
        - "-config.expand-env=true"

      extraEnvFrom:
        - secretRef:
            name: tempo-s3-bucket

    compactor:
      extraArgs:
        - "-config.expand-env=true"

      extraEnvFrom:
        - secretRef:
            name: tempo-s3-bucket

    querier:
      extraArgs:
        - "-config.expand-env=true"

      extraEnvFrom:
        - secretRef:
            name: tempo-s3-bucket

    queryFrontend:
      extraArgs:
        - "-config.expand-env=true"

      extraEnvFrom:
        - secretRef:
            name: tempo-s3-bucket

    traces:
      otlp:
        http:
          enabled: true
        grpc:
          enabled: true

    storage:
      trace:
        backend: s3
        s3:
          insecure: true
          forcepathstyle: false

    overrides:
      defaults:
        metrics_generator:
          processors:
            - service-graphs
            - span-metrics
            - local-blocks

    gateway:
      enabled: true
      replicas: 1
    metaMonitoring:
      serviceMonitor:
        enabled: true
