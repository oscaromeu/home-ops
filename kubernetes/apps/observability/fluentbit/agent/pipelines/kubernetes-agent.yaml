pipeline:
  inputs:
    - name: tail
      alias: kubernetes
      path: /var/log/containers/*.log
      parser: containerd
      tag: kubernetes.*
      skip_empty_lines: true
      skip_long_lines: false
      refresh_interval: 5
      rotate_wait: 30
      ignore_older: 1h
      buffer_chunk_size: 128kb
      buffer_max_size: 256kb
      truncate_long_lines: true

  filters:
    - name: kubernetes
      match: kubernetes.*
      merge_log: false
      kube_tag_prefix: kubernetes.var.log.containers.
      k8s-logging.parser: true
      k8s-logging.exclude: true
      namespace_labels: false
      annotations: false
      buffer_size: 128kb

    # Lift kubernetes fields
    - name: nest
      match: '*'
      operation: lift
      nested_under: kubernetes
      add_prefix: k_

    - name: nest
      match: '*'
      operation: lift
      nested_under: k_labels
      add_prefix: k_labels_

    # Normalize app label
    - name: modify
      match: '*'
      rename: k_labels_app.kubernetes.io/name app
      rename: k_labels_app app
      rename: k_labels_k8s-app app
      rename: k_labels_job-name app

  outputs:

    - name: http
      match: '*'
      host: victoria-logs-server.observability.svc.cluster.local
      port: 9428
      uri: /insert/jsonline?_stream_fields=stream,k_namespace_name,k_pod_name,app&_msg_field=log&_time_field=date
      format: json_lines
      json_date_format: iso8601
      compress: gzip
      log_response_payload: false

    #- name: kafka
    #  match: '*'
    #  timestamp_key: kafka_timestamp
    #  brokers: kafka-cluster-kafka-brokers.databases.svc.cluster.local:9093
    #  topics: cluster-apps-logs
    #  rdkafka.client.id: fluent-bit
    #  rdkafka.enable.ssl.certificate.verification: true
    #  rdkafka.ssl.certificate.location: /fluent-bit/etc/secrets/user.crt
    #  rdkafka.ssl.key.location: /fluent-bit/etc/secrets/user.key
    #  rdkafka.ssl.ca.location: /fluent-bit/etc/secrets/ca.crt
    #  rdkafka.security.protocol: ssl
    #  rdkafka.request.required.acks: 1
    #  rdkafka.message.send.max.retries: 5
    #  rdkafka.retry.backoff.ms: 300
    #  rdkafka.compression.codec: gzip
    #  rdkafka.batch.num.messages: 500
    #  rdkafka.linger.ms: 5
    #  format: json
