---
#
# Sources
#
sources:

  #k3s:
  #  type: redis
  #  url: redis://dragonfly.datahub.svc.cluster.local:6379/0
  #  key: "k3s_prod"
  #  decoding:
  #    codec: json

  #k3s:
  #  type: vector
  #  address: 0.0.0.0:6010
  #  version: "2"

  k3s:
    type: kafka
    bootstrap_servers: redpanda-0.redpanda.datahub.svc.cluster.local.:9093
    topics:
      - k3s-logs
    group_id: k3s-logs-group
    decoding:
      codec: json
    tls:
      enabled: true
      ca_file: "/redpanda-default-cert/ca.crt"
      verify_certificate: true
      verify_hostname: false

#
# Transforms
#
transforms:
  kubernetes_remap:
    type: remap
    inputs: ["k3s"]
    source: |
      # Standardize 'app' index
      .custom_app_name = .pod_labels."app.kubernetes.io/name" || .pod_labels.app || .pod_labels."k8s-app" || "unknown"

      # Standardize 'message' name
      .log = .message

      # Drop pod_labels
      del(.pod_labels)

#
# Sinks
#
sinks:
  elasticsearch:
    type: elasticsearch
    #batch:
    #  max_bytes: 2049000
    inputs:
      - kubernetes_remap
    auth:
      strategy: "basic"
      user: "${ELASTICSEARCH__PASSWORD:-ingestion}"
      password: "${ELASTICSEARCH__PASSWORD:-monitor}"
    data_stream:
      # {data_stream.type}-{data_stream.dataset}-{data_stream.namespace}
      # https://www.elastic.co/guide/en/ecs/master/ecs-data_stream.html
      type: logs
      #dataset: "k3s_prod"
      #namespace: "{{ .kubernetes.pod_namespace }}"
      dataset: "k3s"
      namespace: "prod"
    mode: "data_stream"
    bulk:
      action: "create"
    endpoints:
      - "https://elk-es-http.logging.svc.cluster.local:9200"
    tls:
      verify_certificate: false
    encoding:
      except_fields: ["pod_labels"]

  loki:
    inputs: ["kubernetes_remap"]
    type: loki
    endpoint: http://loki-gateway.logging.svc.cluster.local
    encoding: { codec: json }
    out_of_order_action: accept
    remove_label_fields: true
    remove_timestamp: true
    labels:
      app: '{{ custom_app_name }}'
      namespace: '{{ kubernetes.pod_namespace }}'
      node: '{{ kubernetes.pod_node_name }}'
