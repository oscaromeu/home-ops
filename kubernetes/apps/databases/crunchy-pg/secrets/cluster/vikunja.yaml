---
apiVersion: external-secrets.io/v1
kind: ClusterExternalSecret
metadata:
  name: postgres-${postgres_cluster_version}-vikunja
spec:
  namespaceSelectors:
    - matchLabels:
        kubernetes.io/metadata.name: default
  externalSecretSpec:
    secretStoreRef:
      kind: ClusterSecretStore
      name: onepassword

    target:
      name: vikunja-secret
      template:
        data:
          # App
          VIKUNJA_DATABASE_HOST: &dbHost "{{ .host }}"
          VIKUNJA_DATABASE_DATABASE: &dbName "{{ .dbname }}"
          VIKUNJA_DATABASE_USER: &dbUser "{{ .user }}"
          VIKUNJA_DATABASE_PASSWORD: &dbPass "{{ .password }}"

          # Postgres Init
          INIT_POSTGRES_DBNAME: *dbName
          INIT_POSTGRES_HOST: *dbHost
          INIT_POSTGRES_USER: *dbUser
          INIT_POSTGRES_PASS: *dbPass

          # OIDC
          config.yml: |
            auth:
              local:
                enabled: false
    dataFrom:
      - extract:
          key: postgres-${postgres_cluster_version}-pguser-vikunja
---
apiVersion: external-secrets.io/v1
kind: ClusterExternalSecret
metadata:
  name: postgres-${postgres_cluster_version}-vikunja-superpass
spec:
  namespaceSelectors:
    - matchLabels:
        kubernetes.io/metadata.name: default
  externalSecretSpec:
    secretStoreRef:
      kind: ClusterSecretStore
      name: onepassword
    target:
      name: vikunja-secret-postgres-superpass
      template:
        data:
          # Postgres Init
          INIT_POSTGRES_SUPER_PASS: "{{ .password }}"
    dataFrom:
      - extract:
          key: postgres-${postgres_cluster_version}-pguser-postgres
