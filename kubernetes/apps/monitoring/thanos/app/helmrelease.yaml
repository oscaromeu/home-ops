---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: thanos
  namespace: monitoring
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://charts.bitnami.com/bitnami
      chart: thanos
      version: 12.16.2
      sourceRef:
        kind: HelmRepository
        name: bitnami
        namespace: flux-system
      interval: 5m

  install:
    createNamespace: true
    remediation:
      retries: 5

  upgrade:
    remediation:
      retries: 5

  dependsOn:
    - name: kube-prometheus-stack
      namespace: monitoring
    - name: local-path-provisioner
      namespace: kube-system
    - name: rook-ceph-cluster
      namespace: rook-ceph

  values:
    image:
      registry: quay.io
      repository: thanos/thanos
      tag: v0.32.5
    objstoreConfig:
      type: s3
      config:
        insecure: true

    query:
      enabled: true
      replicaCount: 2
      replicaLabels: ["__replica__"]
      dnsDiscovery:
        sidecarsService: kube-prometheus-stack-thanos-discovery
        sidecarsNamespace: monitoring
      ingress:
        enabled: false
        hostname: "thanos.${SECRET_DOMAIN}"
        ingressClassName: "nginx"
        tls: true
        annotations:
          hajimari.io/enable: "true"
          hajimari.io/icon: simple-icons:prometheus
          external-dns.alpha.kubernetes.io/target: "ingress.${SECRET_DOMAIN}"

    queryFrontend:
      enabled: true
      replicaCount: 2
      extraFlags:
        #- --query-frontend.log-queries-longer-than=60s
        - |-
          --query-range.response-cache-config="config":
            "addr": "redis-headless.datahub.svc.cluster.local:26379"
            "username": ""
            "password": ""
            "db": 1
            "dial_timeout": "5s"
            "read_timeout": "3s"
            "write_timeout": "3s"
            "max_get_multi_concurrency": 100
            "get_multi_batch_size": 100
            "max_set_multi_concurrency": 100
            "set_multi_batch_size": 100
            "tls_enabled": false
            "cache_size": 0
            "expiration": "24h0m0s"
            "master_name": "redis-master"
          "type": "redis"
        - |-
          --labels.response-cache-config="config":
            "addr": "redis-headless.datahub.svc.cluster.local:26379"
            "username": ""
            "password": ""
            "db": 1
            "dial_timeout": "5s"
            "read_timeout": "3s"
            "write_timeout": "3s"
            "max_get_multi_concurrency": 100
            "get_multi_batch_size": 100
            "max_set_multi_concurrency": 100
            "set_multi_batch_size": 100
            "tls_enabled": false
            "cache_size": 0
            "expiration": "24h0m0s"
            "master_name": "redis-master"
          "type": "redis"
      ingress:
        enabled: true
        hostname: "thanos-query-frontend.${SECRET_DOMAIN}"
        ingressClassName: "nginx"
        tls: true
        annotations:
          hajimari.io/enable: "true"
          hajimari.io/icon: simple-icons:prometheus
          external-dns.alpha.kubernetes.io/target: "ingress.${SECRET_DOMAIN}"

    bucketweb:
      enabled: true
      replicaCount: 2


    compactor:
      enabled: true
      extraFlags:
        - --compact.concurrency=4
        - --delete-delay=30m
      retentionResolutionRaw: 90d
      retentionResolution5m: 1y
      retentionResolution1h: 2y
      consistencyDelay: 30m
      compact.concurrency: 6
      downsample.concurrency: 6
      block-sync-concurrency: 60
      persistence:
        enabled: true
        size: 10Gi
        storageClass: "local-path"

    storegateway:
      enabled: true
      replicaCount: 2
      persistence:
        enabled: true
        storageClass: local-path
        size: 10Gi
      extraFlags:
        - |-
          --index-cache.config="config":
            "addr": "redis-headless.datahub.svc.cluster.local:26379"
            "username": ""
            "password": ""
            "db": 1
            "dial_timeout": "5s"
            "read_timeout": "3s"
            "write_timeout": "3s"
            "max_get_multi_concurrency": 100
            "get_multi_batch_size": 100
            "max_set_multi_concurrency": 100
            "set_multi_batch_size": 100
            "tls_enabled": false
            "cache_size": "125MB"
            "expiration": "24h0m0s"
            "master_name": "redis-master"
          "type": "redis"
      podAntiAffinityPreset: hard
  #sharded:
  #  enabled: true
  #  hashPartitioning:
  #    shards: 3
    #timePartitioning:
    #  - min: ""
    #    max: ""
    #service:
    #  clusterIPs: []
    #  loadBalancerIPs: []
    #  http:
    #    nodePorts: []
    #  grpc:
    #    nodePorts: []


    metrics:
      enabled: true
      serviceMonitor:
        enabled: true

  valuesFrom:
    - targetPath: objstoreConfig.config.bucket
      kind: ConfigMap
      name: thanos-bucket-v2
      valuesKey: BUCKET_NAME
    - targetPath: objstoreConfig.config.endpoint
      kind: ConfigMap
      name: thanos-bucket-v2
      valuesKey: BUCKET_HOST
    - targetPath: objstoreConfig.config.region
      kind: ConfigMap
      name: thanos-bucket-v2
      valuesKey: BUCKET_REGION
    - targetPath: objstoreConfig.config.access_key
      kind: Secret
      name: thanos-bucket-v2
      valuesKey: AWS_ACCESS_KEY_ID
    - targetPath: objstoreConfig.config.secret_key
      kind: Secret
      name: thanos-bucket-v2
      valuesKey: AWS_SECRET_ACCESS_KEY
